<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXUS // ULTIMATE</title>
    <meta name="theme-color" content="#000000">
    
    <!-- CORE -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- BACKEND -->
    <script>
        window.Nexus = {
            ready: false,
            provider: localStorage.getItem('nexus_prov') || 'puter',
            key: localStorage.getItem('nexus_key') || ''
        };
    </script>
    <script src="https://js.puter.com/v2/" async onload="window.Nexus.ready = true" onerror="console.warn('Puter Blocked')"></script>

    <style>
        :root {
            --bg-app: #050505;
            --bg-panel: #0A0A0A;
            --bg-surface: #111111;
            --border: #222;
            --text-main: #e0e0e0;
            --text-muted: #666;
            --accent: #8b5cf6; /* Violet */
            --accent-glow: rgba(139, 92, 246, 0.2);
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg-app); color: var(--text-main); height: 100vh; overflow: hidden; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 2px; }
        ::-webkit-scrollbar-thumb { background: #333; }
        
        /* Layout */
        .app-grid { display: grid; grid-template-columns: 50px 1fr; height: 100%; }
        
        /* Sidebar */
        .nav-icon { 
            width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; 
            color: #555; cursor: pointer; transition: all 0.2s; border-radius: 8px; font-lg;
        }
        .nav-icon:hover { background: #111; color: #fff; }
        .nav-icon.active { background: var(--accent-glow); color: var(--accent); box-shadow: 0 0 10px var(--accent-glow); }

        /* Editor */
        .ide-grid { display: grid; grid-template-columns: 1fr 1fr 350px; height: 100%; background: #000; }
        @media (max-width: 900px) { .ide-grid { grid-template-columns: 1fr; } .copilot-col { display: none; } }
        .code-editor { font-family: 'JetBrains Mono', monospace; font-size: 13px; background: #0d1117; color: #c9d1d9; line-height: 1.5; resize: none; }
        
        /* Terminal */
        .cli-output { font-family: 'JetBrains Mono', monospace; font-size: 12px; color: #22c55e; white-space: pre-wrap; }
        
        /* Game Engine */
        .engine-grid { display: grid; grid-template-columns: 240px 1fr; height: 100%; background: #000; }
        canvas { background: #0a0a0a; cursor: crosshair; box-shadow: inset 0 0 20px rgba(0,0,0,0.8); border: 1px solid #111; }

        /* Glass & Utils */
        .glass-panel { background: rgba(10, 10, 10, 0.9); backdrop-filter: blur(10px); border: 1px solid var(--border); }
        .input-dark { background: #000; border: 1px solid #222; color: #fff; outline: none; }
        .input-dark:focus { border-color: var(--accent); }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .anim { animation: fadeIn 0.3s ease-out; }
    </style>
</head>
<body>

    <!-- SIDEBAR -->
    <div class="app-grid">
        <aside class="bg-black border-r border-[#111] flex flex-col items-center py-2 gap-1">
            <div class="w-8 h-8 rounded bg-violet-600 flex items-center justify-center text-white font-bold mb-4 shadow-lg shadow-violet-600/20">N</div>
            
            <div onclick="App.navigate('chat')" class="nav-icon active" title="Chat" id="nav-chat">üí¨</div>
            <div onclick="App.navigate('ide')" class="nav-icon" title="IDE" id="nav-ide">üíª</div>
            <div onclick="App.navigate('terminal')" class="nav-icon" title="Terminal" id="nav-terminal">‚å®Ô∏è</div>
            <div onclick="App.navigate('engine')" class="nav-icon" title="Engine" id="nav-engine">üéÆ</div>
            <div onclick="App.navigate('playground')" class="nav-icon" title="Visuals" id="nav-playground">üé®</div>
            <div onclick="App.navigate('radio')" class="nav-icon" title="Radio" id="nav-radio">üìª</div>
            
            <div class="mt-auto flex flex-col gap-1">
                <div onclick="App.navigate('settings')" class="nav-icon" title="Settings" id="nav-settings">‚öôÔ∏è</div>
            </div>
        </aside>

        <!-- MAIN VIEW CONTAINER -->
        <main id="main-container" class="relative overflow-hidden">
            
            <!-- 1. CHAT VIEW -->
            <section id="view-chat" class="absolute inset-0 flex flex-col p-4 anim">
                <div id="chat-log" class="flex-1 overflow-y-auto space-y-4 pr-4 pb-16">
                    <div class="text-center text-gray-600 text-xs pt-20">Welcome to Nexus. AI Online.</div>
                </div>
                <div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black to-transparent">
                    <div class="flex gap-2">
                        <input id="chat-input" type="text" placeholder="Send a message..." class="flex-1 input-dark rounded-lg px-4 py-2 text-sm">
                        <button onclick="App.chat.send()" class="bg-violet-600 hover:bg-violet-500 px-4 py-2 rounded-lg text-xs font-bold transition">SEND</button>
                    </div>
                </div>
            </section>

            <!-- 2. IDE VIEW -->
            <section id="view-ide" class="absolute inset-0 hidden flex-col">
                <header class="h-10 bg-[#0a0a0a] flex items-center px-4 border-b border-[#111]">
                    <span class="text-xs text-violet-400 font-bold">IDE WORKSPACE</span>
                    <button onclick="App.ide.run()" class="ml-4 text-[10px] px-2 py-1 bg-green-900/30 text-green-400 border border-green-500/20 rounded hover:bg-green-900/50">‚ñ∂ PREVIEW</button>
                </header>
                <div class="ide-grid flex-1">
                    <div class="flex flex-col overflow-hidden">
                        <textarea id="ide-code" class="code-editor flex-1 p-3 outline-none" spellcheck="false">
<!DOCTYPE html>
<html>
<head>
    <style>
        body { background: #111; color: white; font-family: sans-serif; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        h1 { text-shadow: 0 0 10px #8b5cf6; }
    </style>
</head>
<body>
    <h1>Hello Nexus</h1>
</body>
</html>
                        </textarea>
                    </div>
                    <div class="bg-white relative flex flex-col border-l border-[#111]">
                        <iframe id="ide-preview" class="flex-1 w-full border-none"></iframe>
                    </div>
                    
                    <!-- COPILOT -->
                    <div class="copilot-col bg-[#050505] border-l border-[#111] flex flex-col overflow-hidden">
                        <div class="p-2 border-b border-[#111] flex justify-between items-center">
                            <span class="text-[10px] text-violet-400 font-bold uppercase">Copilot</span>
                        </div>
                        <div class="p-2 flex gap-1 border-b border-[#111]">
                            <button onclick="App.ide.fix()" class="flex-1 text-[9px] px-2 py-1 bg-green-900/30 text-green-300 rounded hover:bg-green-900/50 transition">‚ö° Fix</button>
                            <button onclick="App.ide.improve()" class="flex-1 text-[9px] px-2 py-1 bg-blue-900/30 text-blue-300 rounded hover:bg-blue-900/50 transition">üöÄ Improve</button>
                            <button onclick="App.ide.explain()" class="flex-1 text-[9px] px-2 py-1 bg-gray-900/30 text-gray-300 rounded hover:bg-gray-900/50 transition">‚ùì Explain</button>
                        </div>
                        <div id="ide-log" class="flex-1 overflow-y-auto p-2 font-mono text-[10px] text-gray-400 space-y-1"></div>
                        <div class="p-2 bg-black border-t border-[#111]">
                            <div class="flex gap-1">
                                <input id="ide-input" type="text" placeholder="Ask AI..." class="flex-1 input-dark rounded px-2 py-1 text-[10px]">
                                <button onclick="App.ide.ask()" class="bg-violet-600 text-white px-2 rounded text-[10px]">GO</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 3. TERMINAL VIEW -->
            <section id="view-terminal" class="absolute inset-0 hidden flex-col bg-[#050505]">
                <div id="term-output" class="flex-1 overflow-y-auto p-4 cli-output">
                    <div class="text-green-500">> System Online. AI Connected.</div>
                    <div class="text-gray-600">> Type 'help' for commands or chat with AI.</div>
                </div>
                <div class="h-10 border-t border-[#111] flex items-center px-2 bg-[#0a0a0a]">
                    <span class="text-violet-400 text-xs mr-2">></span>
                    <input id="term-input" type="text" class="flex-1 bg-transparent text-green-400 text-xs outline-none font-mono" placeholder="Enter Command...">
                </div>
            </section>

            <!-- 4. GAME ENGINE VIEW -->
            <section id="view-engine" class="absolute inset-0 hidden flex-col">
                <div class="engine-grid">
                    <aside class="bg-[#050505] border-r border-[#111] p-3 overflow-y-auto">
                        <div class="text-[10px] text-gray-500 uppercase mb-2">Entity Fabricator</div>
                        <div class="space-y-2">
                            <button onclick="App.engine.add('player')" class="w-full text-[10px] text-left px-2 py-1 bg-green-900/20 text-green-400 rounded hover:bg-green-900/40 border border-green-500/20">+ Add Player</button>
                            <button onclick="App.engine.add('enemy')" class="w-full text-[10px] text-left px-2 py-1 bg-red-900/20 text-red-400 rounded hover:bg-red-900/40 border border-red-500/20">+ Add Enemy</button>
                            <button onclick="App.engine.add('wall')" class="w-full text-[10px] text-left px-2 py-1 bg-gray-900/20 text-gray-400 rounded hover:bg-gray-900/40 border border-gray-500/20">+ Add Wall</button>
                        </div>
                        
                        <div class="mt-4 pt-4 border-t border-[#111]">
                             <div class="text-[10px] text-gray-500 uppercase mb-2">Controls</div>
                             <button onclick="App.engine.start()" class="w-full bg-violet-600 text-white text-[10px] py-1 rounded">START</button>
                             <button onclick="App.engine.stop()" class="w-full bg-gray-800 text-white text-[10px] py-1 rounded mt-1">STOP</button>
                        </div>
                    </aside>
                    <main class="flex flex-col items-center justify-center bg-black relative">
                        <canvas id="engine-canvas" width="800" height="600"></canvas>
                        <div class="absolute top-2 left-2 text-[10px] font-mono text-gray-600">Engine v2.0</div>
                    </main>
                </div>
            </section>

            <!-- 5. PLAYGROUND VIEW -->
            <section id="view-playground" class="absolute inset-0 hidden flex-col md:flex-row bg-[#050505]">
                <aside class="w-64 p-4 border-r border-[#111] space-y-3 overflow-y-auto">
                    <textarea id="img-prompt" class="w-full h-20 input-dark rounded p-2 text-xs" placeholder="Describe image..."></textarea>
                    <div class="flex flex-wrap gap-1">
                        <button onclick="App.img.add('Cyberpunk')" class="px-2 py-1 bg-gray-900 rounded text-[9px] hover:bg-gray-800">Cyberpunk</button>
                        <button onclick="App.img.add('Photorealistic')" class="px-2 py-1 bg-gray-900 rounded text-[9px] hover:bg-gray-800">Real</button>
                    </div>
                    <button onclick="App.img.gen()" class="w-full bg-violet-600 text-white py-2 rounded text-xs font-bold">GENERATE</button>
                </aside>
                <main class="flex-1 flex items-center justify-center relative grid-bg">
                    <img id="img-out" class="max-h-full max-w-full rounded shadow-2xl hidden">
                    <div id="img-loader" class="absolute inset-0 flex items-center justify-center bg-black/80 z-10 hidden text-violet-400 text-xs animate-pulse">Rendering...</div>
                    <div id="img-place" class="text-gray-800 text-xs">OUTPUT</div>
                </main>
            </section>

            <!-- 6. RADIO VIEW -->
            <section id="view-radio" class="absolute inset-0 hidden p-4 overflow-y-auto">
                <div class="max-w-md mx-auto space-y-4">
                    <input id="radio-search" type="text" placeholder="Search Stations..." class="w-full input-dark rounded px-3 py-2 text-sm">
                    <div id="radio-list" class="space-y-1"></div>
                    <div id="radio-player" class="hidden glass-panel p-3 rounded">
                        <div class="text-[10px] text-violet-400 mb-1" id="radio-title">...</div>
                        <audio id="radio-audio" controls class="w-full h-8"></audio>
                    </div>
                </div>
            </section>

            <!-- 7. SETTINGS VIEW -->
            <section id="view-settings" class="absolute inset-0 hidden flex items-center justify-center bg-black/90">
                <div class="glass-panel p-6 rounded-xl w-full max-w-sm border border-violet-900/20 anim">
                    <h3 class="text-lg font-bold text-white mb-4">Settings</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="text-[10px] text-gray-500 block mb-1">AI Provider</label>
                            <select id="sel-prov" onchange="App.settings.ui()" class="w-full input-dark p-2 rounded">
                                <option value="puter">Puter.ai (Free)</option>
                                <option value="groq">Groq (Manual)</option>
                            </select>
                        </div>
                        <div id="wrap-key" class="opacity-40 pointer-events-none">
                            <label class="text-[10px] text-gray-500 block mb-1">API Key</label>
                            <input type="text" id="txt-key" placeholder="gsk_..." class="w-full input-dark p-2 rounded">
                        </div>
                        <button onclick="App.settings.save()" class="w-full bg-violet-600 text-white py-2 rounded text-xs font-bold mt-2">SAVE & RELOAD</button>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <script>
        // --- CORE UTILS ---
        const $ = id => document.getElementById(id);
        const Log = (msg, type = 'text') => console.log(`[NEXUS] ${msg}`);

        // --- APP LOGIC ---
        const App = {
            state: { currentView: 'chat', connected: false },
            
            init: function() {
                // Listeners
                $('chat-input').addEventListener('keydown', e => { if(e.key==='Enter') this.chat.send(); });
                $('ide-input').addEventListener('keydown', e => { if(e.key==='Enter') this.ide.ask(); });
                $('term-input').addEventListener('keydown', e => { if(e.key==='Enter') this.terminal.process(); });
                $('radio-search').addEventListener('input', e => this.radio.search(e.target.value));

                // Load Settings
                $('sel-prov').value = Nexus.provider;
                $('txt-key').value = Nexus.key;
                this.settings.ui();

                // Boot Check
                let attempts = 0;
                const int = setInterval(() => {
                    if ((Nexus.provider === 'puter' && Nexus.ready) || (Nexus.provider === 'groq' && Nexus.key)) {
                        clearInterval(int);
                        this.state.connected = true;
                        this.navigate('chat');
                        this.ui.status("ONLINE", "green");
                    } else if (attempts > 30) {
                        clearInterval(int);
                        this.navigate('settings');
                    }
                    attempts++;
                }, 100);
            },

            navigate: function(view) {
                document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
                document.querySelectorAll('.nav-icon').forEach(el => el.classList.remove('active'));
                
                $(`view-${view}`).classList.remove('hidden');
                $(`nav-${view}`).classList.add('active');
                this.state.currentView = view;
                
                // Run IDE on open
                if(view === 'ide') setTimeout(() => this.ide.run(), 100);
            },

            ui: {
                status: function(text, color) {
                    const nav = $('nav-chat');
                    if(color === 'green') nav.style.color = '#22c55e';
                    else nav.style.color = '#ef4444';
                }
            },

            askAI: async function(prompt) {
                // Puter
                if (Nexus.provider === 'puter' && Nexus.ready) {
                    try {
                        return await puter.ai.chat(prompt);
                    } catch(e) { return `Error: ${e.message}`; }
                }
                // Groq
                if (Nexus.provider === 'groq' && Nexus.key) {
                    try {
                        const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                            method: "POST",
                            headers: { "Authorization": `Bearer ${Nexus.key}`, "Content-Type": "application/json" },
                            body: JSON.stringify({ model: "llama-3.3-70b-versatile", messages: [{role:"user", content:prompt}] })
                        });
                        const data = await res.json();
                        return data.choices[0].message.content;
                    } catch(e) { return `Groq Error: ${e.message}`; }
                }
                return "AI OFFLINE. Configure in Settings.";
            },

            // --- MODULES ---
            chat: {
                send: async function() {
                    const input = $('chat-input');
                    const text = input.value.trim(); if(!text) return; input.value = "";
                    
                    const bubble = document.createElement('div');
                    bubble.className = "p-3 rounded-xl max-w-md text-sm anim";
                    bubble.className += " ml-auto bg-violet-900/30 border border-violet-500/20";
                    bubble.innerHTML = text;
                    $('chat-log').appendChild(bubble);

                    const aiBubble = document.createElement('div');
                    aiBubble.className = "p-3 rounded-xl max-w-md text-sm anim glass-panel border-gray-800";
                    aiBubble.innerText = "...";
                    $('chat-log').appendChild(aiBubble);

                    $('chat-log').scrollTop = 9999;
                    const res = await App.askAI(text);
                    aiBubble.innerText = res;
                }
            },

            ide: {
                run: function() {
                    const doc = $('ide-preview').contentDocument;
                    doc.open();
                    doc.write($('ide-code').value);
                    doc.close();
                },
                log: function(t, type) {
                    const div = document.createElement('div');
                    div.className = type === 'ai' ? 'text-green-400' : 'text-gray-500';
                    div.innerText = `> ${t}`;
                    $('ide-log').appendChild(div);
                    $('ide-log').scrollTop = 999;
                },
                fix: async function() {
                    this.log("Analyzing...", 'sys');
                    const code = $('ide-code').value;
                    const res = await App.askAI(`Fix this code. Return ONLY code:\n\n${code}`);
                    $('ide-code').value = res;
                    this.run();
                    this.log("Code Updated.", 'ai');
                },
                improve: async function() {
                    this.log("Improving...", 'sys');
                    const code = $('ide-code').value;
                    const res = await App.askAI(`Improve logic. Return ONLY code:\n\n${code}`);
                    $('ide-code').value = res;
                    this.run();
                    this.log("Code Improved.", 'ai');
                },
                explain: async function() {
                    this.log("Analyzing...", 'sys');
                    const res = await App.askAI(`Explain this code simply:\n\n${$('ide-code').value}`);
                    this.log(res, 'ai');
                },
                ask: async function() {
                    const q = $('ide-input').value; if(!q) return; $('ide-input').value = "";
                    this.log(`User: ${q}`, 'sys');
                    const res = await App.askAI(q);
                    this.log(res, 'ai');
                }
            },

            terminal: {
                process: async function() {
                    const input = $('term-input');
                    const cmd = input.value; input.value = "";
                    
                    const ln = document.createElement('div'); ln.innerText = `> ${cmd}`; $('term-output').appendChild(ln);
                    
                    // Intercept basic commands
                    if(cmd === 'clear') { $('term-output').innerHTML = ''; return; }
                    if(cmd === 'help') { 
                        const help = document.createElement('div');
                        help.innerText = "Available: clear, help, chat [msg]";
                        help.className = 'text-gray-500 mb-2';
                        $('term-output').appendChild(help);
                        return;
                    }

                    // Use AI for everything else
                    const res = await App.askAI(`User typed command in terminal: "${cmd}". Execute or respond.`);
                    const resLn = document.createElement('div');
                    resLn.innerText = res;
                    resLn.className = 'text-gray-300 mb-2';
                    $('term-output').appendChild(resLn);
                    $('term-output').scrollTop = 9999;
                }
            },

            engine: {
                entities: [],
                loop: null,
                ctx: null,
                init: function() {
                    if(this.ctx) return;
                    this.ctx = $('engine-canvas').getContext('2d');
                    this.loop = setInterval(() => this.draw(), 16);
                },
                add: function(type) {
                    this.init();
                    const ent = {
                        type: type,
                        x: 400, y: 300,
                        w: 20, h: 20,
                        color: type === 'player' ? '#22c55e' : type === 'enemy' ? '#ef4444' : '#333',
                        vx: (Math.random() - 0.5) * 4,
                        vy: (Math.random() - 0.5) * 4
                    };
                    this.entities.push(ent);
                },
                start: function() { /* Logic running already */ },
                stop: function() { clearInterval(this.loop); this.loop = null; },
                draw: function() {
                    this.ctx.fillStyle = '#050505';
                    this.ctx.fillRect(0, 0, 800, 600);
                    
                    this.entities.forEach(e => {
                        // Simple Physics
                        e.x += e.vx;
                        e.y += e.vy;
                        if(e.x < 0 || e.x > 780) e.vx *= -1;
                        if(e.y < 0 || e.y > 580) e.vy *= -1;
                        
                        // Draw
                        this.ctx.fillStyle = e.color;
                        this.ctx.fillRect(e.x, e.y, e.w, e.h);
                    });
                }
            },

            img: {
                add: function(style) { $('img-prompt').value += `, ${style}`; },
                gen: function() {
                    const prompt = $('img-prompt').value; if(!prompt) return;
                    $('img-loader').classList.remove('hidden');
                    const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?nologo=true&seed=${Date.now()}`;
                    const img = new Image();
                    img.onload = () => {
                        $('img-out').src = url;
                        $('img-loader').classList.add('hidden');
                        $('img-out').classList.remove('hidden');
                    };
                    img.src = url;
                }
            },

            radio: {
                debounce: null,
                search: function(q) {
                    clearTimeout(this.debounce);
                    if(q.length < 3) return;
                    this.debounce = setTimeout(async () => {
                        const res = await fetch(`https://de1.api.radio-browser.info/json/stations/byname/${encodeURIComponent(q)}?limit=6`);
                        const data = await res.json();
                        $('radio-list').innerHTML = '';
                        data.forEach(s => {
                            const d = document.createElement('div');
                            d.className = 'p-2 rounded hover:bg-white/5 cursor-pointer text-xs flex justify-between';
                            d.innerHTML = `<span>${s.name}</span><span class="text-violet-400">${s.country}</span>`;
                            d.onclick = () => {
                                $('radio-audio').src = s.url_resolved;
                                $('radio-audio').play();
                                $('radio-title').innerText = s.name;
                                $('radio-player').classList.remove('hidden');
                            };
                            $('radio-list').appendChild(d);
                        });
                    }, 400);
                }
            },

            settings: {
                ui: function() {
                    const prov = $('sel-prov').value;
                    const wrap = $('wrap-key');
                    if(prov === 'puter') wrap.classList.add('opacity-40', 'pointer-events-none');
                    else wrap.classList.remove('opacity-40', 'pointer-events-none');
                },
                save: function() {
                    localStorage.setItem('nexus_prov', $('sel-prov').value);
                    localStorage.setItem('nexus_key', $('txt-key').value);
                    location.reload();
                }
            }
        };

        App.init();
    </script>
</body>
</html>
